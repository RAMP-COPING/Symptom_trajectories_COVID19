---
title: "Run Latent Class Growth Analyses and Growth Mixture Modelling for RAMP longitudinal analyses of common mental health symptoms: GAD and PHQ"
author: "K L Purves"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: false
    number_sections: false
    highlight: monochrome
    theme: cerulean
code_folding: hide

html_notebook:
  theme: cerulean
toc: yes
---

This workbook centralises analyses of the PHQ-9 and GAD-7 total scores longitudinal analyses in the RAMP and COPING samples. This corresponds with analytic steps 1-2 in the pre-registration for project ["Moderators of symptom trajectories of depression and anxiety during the COVID-19 pandemic"](https://osf.io/jvca5/).

The analytic steps that will be followed for both PHQ and GAD are:

Step 1. Identifying overall group trajectories of anxiety and depression (Latent Growth Curve Modelling; using total scores across all timepoints for whole sample) 

Step 2. Identifying optimal numbers of subgroup trajectories of anxiety and depression (Growth Mixture Modelling)

***Setup***


```{r}
# clear global environment
remove(list = ls())
```


***note: some of the install and update processes require command line verification in the console. If you are running this script for the first time and it does not proceed, open and check the console***


```{r setup, include=FALSE}

# Install / load packages

if(!require(knitr)){
  install.packages("knitr")
  library(knitr)
}

if(!require(summarytools)){
  install.packages("summarytools")
  library(summarytools)
}

if(!require(data.table)){
  install.packages("data.table")
  library(data.table)
}


if(!require(kableExtra)){
  install.packages("kableExtra")
  library(kableExtra)
}

if(!require(glue)){
  install.packages("glue")
  library(glue)
}

if(!require(MplusAutomation)){
  install.packages("MplusAutomation")
  library(MplusAutomation)
}



if(!require(texreg)){
  install.packages("texreg")
  library(texreg)
}

if(!require(relimp)){
  install.packages("relimp")
  library(relimp)
}

if(!require(BiocManager)){
  install.packages("BiocManager")
  library(BiocManager)
}

if(!require(rhdf5)){
  BiocManager::install("rhdf5")
  library(rhdf5)
}

if(!require(plyr)){
  install.packages("plyr")
  library(plyr)
}


if(!require(tidyverse)){
  install.packages("tidyverse")
  library(tidyverse)
}

library(kableExtra)

## global workbook settings


knitr::opts_chunk$set(results = 'asis',      
                      comment = NA,
                      prompt = FALSE,
                      cache = FALSE, 
                      warning = FALSE,
                      echo = TRUE,
                      fig.height = 5,
                      fig.width = 10,
                      fig.align = "center")

st_options(plain.ascii = FALSE,       
            style = "rmarkdown",      
            footnote = NA,            
            subtitle.emphasis = FALSE)                         


options(scipen = 999)
```


***Colour palette***

RAMP colours (first) from website and second is a generated left tetradic (rectangular) colour complement of the RAMP logo green for contrast and complement. 
```{r ieso colour palette, include=FALSE}

pres.palette <- c("#4ED1B7", "#F6C66A", "#6A6680", "#1A3E72",  "#D1754D","#FFED04","#3F9D8A","#B74DD1") 

prev.pres.palette<-c("#4590B8", "#4D68D1", "#D14D68", "#D1B74D", "#68D14D", "#B74DD1", "#D1754D")

```


# Step 1. Latent Growth Curves 

Identify the best fitting latent growth curve form, i.e. that which fits all of the data best, on average, for each outcome.

## Notes on timepoints included

1. The MPlus input time interval specifications go from increasing by 1 for the first 8 follow-ups (we measured with two week intervals) to increasing by 2 for the remaining timepoints when we moved to monthly. The choice of interval is arbitrary, but the relative difference should be retained. 

2. We dropped timepoints 1 & 2 (see 'Overview of model alterations and adaptations' below)

## Overview of of models

* Linear
* Quadratic
* Piecewise: four pieces, corresponding with lockdowns and easing of restrictions between April 2020 and April 2021 (see below)
* Each of these models will be repeated, including pairwise correlations between consecutive timepoints

### Piecewise trajectory key dates

Four pieces   
***These dates are based on guidelines in England - TO CHECK no major discrepancies across Scotland; NI; Wales***

1. Lockdown 1 (23 Mar 2020) until first easing of restrictions (23 Jun 2020)  

Slope includes data points: **Baseline** (7 Apr 2020) - **Follow-up 5** (16 Jun 2020)

2. Summer easing of restrictions (23 Jun 2020) until beginning of Lockdown 2.0 (31 Oct 2020)  

Slope includes data points: **Follow-up 6** (30 Jun 2020) - **Follow-up 11** (20 Oct 2020)

3. Winter lockdowns (31 Oct 2020) until Spring 2021 easing of restrictions (8 Mar 2021) 

Slope includes data points: **Follow-up 12** (17 Nov 2020) - **Follow-up 15** (9 Feb 2021) 

4. Spring 2021 easing of restrictions (8 Mar 2021) until end of study period (6 Apr 2021) 

Slope includes data points: **Follow-up 16** (9 Mar 2021) - **Follow-up 17** (6 Apr 2021) 

Notes on lockdowns  

**England**:  

* Lockdown 2.0: 31 Oct 2020-1 Dec 2020  

* Easing of restrictions + tier system: 2 Dec 2020 (Tier 3) - 20 Dec 2020 (Tier 4 introduced) 

* Lockdown 3: 6 Jan 2021 - 8 Mar 2021   


Scotland: 

Wales:

Northern Ireland: 


## PHQ-9: Current Depression Symptoms Latent Growth Curve Model {.tabset}

### Covariance coverage issue

After manual checks of each stage, an issue with covariance coverage was detected. The resolution is detailed here. 

The covariance coverage (% of participants common to any two time points) between some time points is lower than MPlus default (0.1; 10%). This prevents algorithm for missing data being applied (MLR; maximum likelihood with robust standard errors) and standard errors cannot be computed, even when setting the coverage expectations to zero. 

Looking at our data structure and MPlus output, this is due to missing data for follow-up 2 & 3 (RAMP only, no COPING data) resulting in perfect zero covariance coverage with follow-up 17 (currently COPING only; RAMP data extraction issue).

**CHANGE TO MODEL**: Now running without timepoints 2 & 3 

### Data summary

```{r read in phq and check missing all cases}

phq_check <-  readRDS("../../../data_clean/phq/phq.clean_merged_total_scores.rds")

# get a list of the total score columns
total_cols <- grep("total_Wave", names(phq_check))

#count how many columns we have
n_cols <- length(total_cols)

# create a list of how many NAs are missing across these 18 columns per row
list_n_missing <- apply(phq_check[total_cols],1,function(x) sum(is.na(x)))

# count how many people are missing data for all columns (NA = total_cols)
list_all_missing <-  sum(list_n_missing ==n_cols)

print(dim(phq_check)[1])
print(list_all_missing)

```


Important note: all numbers correspond exactly with MPlus output numbers (n per wave and n missing all observations etc).
  
   

#### run all models 

Don't rerun models if there is already output for it (to save computational time), do show the output in the console
***IN FINAL MAKE SURE SCRIPT STATES eval=FALSE so that MPlus models aren't rerun***

```{r run depression linear models, eval=FALSE}

runModels("./MPlus_input_lcga/PHQ", 
          recursive = FALSE,
          showOutput=TRUE,
          replaceOutfile="never")

```

### Examine model output {.tabset}
This reads in all output, including the gh5 plot files
```{r read depression model}

dep.traj.all <- readModels("./MPlus_input_lcga/PHQ", 
                           recursive=FALSE)

```


#### Check warnings, error messages and residuals {.tabset}

- Warnings: check through warnings from console  
- Errors: error messages when running models and how each was resolved
- Residuals: check if any residual variances are negative and significant (would indicate model error)
- loadings of indicators and intercept should all be 1, and estimates should relate to the time points you specified (e.g. lin 0, 1, 2; quad 0, 1, 4) 
- intercept 0 for all and correlations look sensible

##### Warnings

at the moment this doesnt say which model the warning is from, so any warning requires checking to identify its source. Though order in list will give some indication
```{r check warnings}

justWarnings <- do.call("paste",
  sapply(dep.traj.all ,"[", "warnings"))

justWarnings

```

Warnings are all about missing data (missing on all obs, this number lines up with our expectations from the dataset in the section above) 


Otherwise, no warnings. Check one complete.

Note that there are more people missing on all observations having dropped time points 2,3, and 17. Was 7866, but this version is 8217 .


##### errors

All resolved. See below sections for descriptions.

Check any errors with running any of the models. Output here will not say which model it belongs to, so will need to manually examine if errors occur,

```{r check errors}

justErrors <- do.call("paste",
  sapply(dep.traj.all ,"[", "errors"))

justErrors

```

###### Issue 1: Models fail to finish running and converge (resolved)

Some of the models have failed to converge:    

* Piecewise with pairwise residual correlations    
* Quadratic   
* Quadratic with pariwise residual correlations


Steps:    
* Increased number of iterations to 5000 (Mplus default is 1000).    
* This worked somewhat for the piecewise and quadratic (without pairwise correlations) which now have more informative errors    
* This did not work at all for quadratic (with pairwise residual correlation). Increased iterations to 10000 for this one.    
* This worked.    


###### Issue 2: Models are no specified due to time point 3 parameter (resolved)

Now all three run, but could not compute standard errors as the models were misidentified or did not converge.

Issues are all with specified parameters now:

***quadratic***: Problem involving parameter 2 (T_3)
*   examining the data, I have made an error with the dataset. There are 4325 in this time point. This corresponds to the second follow up that is meant to be dropped from this datafile. Interestingly, T4 onwards is correct. T3 should have 2662 observations. Appears I have  wrongly dropped this wave instead of follow up 2. *Note: this is exactly what I had done. Corrected and rerun all models*

###### Issue 3: Models are no specified due to low coverage covariacne between t 3 and timepoint 6,8,16 (resolved. CHECK WITh KATIE)

Checked this manually, and there are only 4 people who did both timepoint 3 and timepoint 6, 4 who did timepoint 3 and tomepoint 8, and only 3 who did time point 3 and timepoint 16

* issues to consider here include the fact that having low observed data can caus instability and may lead to ore groups than there really are at a later stage   
* On the other hand, the fixed dataset now has good coverage for all other pairings ( min 0.007, representing > 100 people in all cases). Thus dropping this time point might lose more information than it gains.

Options are either dropping time point 3, or dropping coverage requirement.

* tried dropping coverage requirement to see if there remained problems with parameter 3 that would indicate instability.

###### Issue 4: Quadratic models misspecifed (resolved)

The two quadratic models are not converging. Without pairwise correlations the parameter MPlus flags is the intercept. With pairwise correlation it flags the correlations between time points 15 and 16

* Checked the quadratic output for intercept and noticed some very high variances. I thus specified the model allowing the intercept variance to be freed instead of constrained
* Increasing the number of start value attempts from default 10 2 to 50 5 (50 initial stage starts, 5 final stage optimisations), then 500 initial starts **did not work**
* Fixing the intercept to 0,40 (variance) 7 (mean) **did not work**
* made time interval references smaller: MPlus course taught us that models can fail to specify if the numbers that identify relative time intervals are too large. I made it so that 0.5 represented an interval of 2 weeks, instead of 1 ***THIS WORKED***    

###### Issue 5: 4 piece model with pairwise residuals correlated misspecifed (resolved)

* likely due to the 4th piece relying only on two time points, fixed variance for this slope to 0 to only estimate means [(e.g. Muthen response to this thread)](http://www.statmodel.com/discussion/messages/14/217.html?1563568933).    

##### Residuals

###### Linear 
```{r check if residual variances negative lin}

model <- dep.traj.all$phq_latentGrowthCurve_linear.out$parameters$unstandardized
model[model$paramHeader == "Residual.Variances",]

```

###### Linear with pairwise correlations
```{r check if residual variances negative lin pairwise}

model <- dep.traj.all$phq_latentGrowthCurve_linear_withpairwiseCorrelations.out$parameters$unstandardized
model[model$paramHeader == "Residual.Variances",]

```

###### Quadratic 
```{r check if residual variances negative quad}

model <- dep.traj.all$phq_latentGrowthCurve_quadratic.out$parameters$unstandardized
model[model$paramHeader == "Residual.Variances",]

```

###### Quadratic with pairwise correlations
```{r check if residual variances negative quad pairwise}

model <- dep.traj.all$phq_latentGrowthCurve_quadratic_withPairwiseCorrelations.out$parameters$unstandardized
model[model$paramHeader == "Residual.Variances",]

```

###### Piecewise 1 (4 piece)
```{r check if residual variances negative piece 1, eval=FALSE}

model <- dep.traj.all$phq_latentGrowthCurve_piecewise_version1_4pieces.out$parameters$unstandardized
model[model$paramHeader == "Residual.Variances",]

```

###### Piecewise 1 with pairwise correlations 
```{r check if residual variances negative piece 1 pairwise, eval=FALSE}

model <- dep.traj.all$phq_latentGrowthCurve_piecewise_version1_4pieces_wPairwise_correlations.out$parameters$unstandardized
model[model$paramHeader == "Residual.Variances",]

```


###### Piecewise 2
```{r check if residual variances negative piece 2}

model <- dep.traj.all$phq_latentGrowthCurve_piecewise_version2_3pieces.out$parameters$unstandardized
model[model$paramHeader == "Residual.Variances",]

```

###### Piecewise 2 with pairwise correlations
```{r check if residual variances negative piece 2 pairwise}

model <- dep.traj.all$phq_latentGrowthCurve_piecewise_version2_3pieces_wPairwiseCorrelations.out$parameters$unstandardized
model[model$paramHeader == "Residual.Variances",]

```

#### Check indicators, intercepts, timepoints and correlations {.tabset}

***Check:***    
1. Loadings: check loadings of indicators and intercepts are 1    
2. Estimates: check estimates relate to specified timepoints   
3. Intercept: check intercept 0 for all     
4. Correlations: check correlations look sensible      

Print output file for each correlation for examination of these details and any other relevant information

##### Loadings:  
Check loadings of indicators and intercepts are 1    

######Linear:  
***YES***
######Linear with pairwise correlations: 
***YES***
######Quadratic: 
***YES***
######Quadratic with pairwise correlations: 
***YES***
######Piecewise: 
to check
######Piecewise with pairwise correlations: 
***YES***

##### Estimates: 
Check estimates relate to specified timepoints   
###### 2. Estimates relate to specified timepoints  
***YES***


```{r check full output negative lin}

dep.traj.all$phq_latentGrowthCurve_linear.out$output[277:311]

```

######  3. intercept 0 for all  
***YES***

```{r check intercepts are zero lin}

dep.traj.all$phq_latentGrowthCurve_linear.out$output[319:337]
```

###### 4. correlations look sensible   
***yes***
```{r check correlations lin}

dep.traj.all$phq_latentGrowthCurve_linear.out$output[598:642]
```


##### Linear (with pairwise correlations between time points)

###### 1. loadings of indicators and intercepts are 1   
***YES***

###### 2. Estimates relate to specified timepoints  
***YES***

```{r check full output negative lin pairwise}

dep.traj.all$phq_latentGrowthCurve_linear_withpairwiseCorrelations.out$output[277:311]

```

###### 3. intercept 0 for all  
***YES***

```{r check intercepts are zero lin pairwise}

dep.traj.all$phq_latentGrowthCurve_linear_withpairwiseCorrelations.out$output[365:380]
```

###### 4. correlations look sensible  
***yes***
```{r check correlations lin pairwise}

dep.traj.all$phq_latentGrowthCurve_linear_withpairwiseCorrelations.out$output[685:727]
```


##### Quadratic

###### 1. loadings of indicators and intercepts are 1   
***YES***

###### 2. Estimates relate to specified timepoints  
***YES***
```{r check full output negative quad}

dep.traj.all$phq_latentGrowthCurve_quadratic.out$output[286:339]

```

###### 3. intercept 0 for all  
***YES***

```{r check intercepts are zero quad}

dep.traj.all$phq_latentGrowthCurve_quadratic.out$output[463:484]
```

###### 4. correlations look sensible  
***YES***
```{r check correlations quad}

dep.traj.all$phq_latentGrowthCurve_quadratic.out$output[654:697]
```


##### Quadratic with pairwise correlations

###### 1. loadings of indicators and intercepts are 1  
***YES***

###### 2. Estimates relate to specified timepoints  
***YES***
```{r check full output negative quad pairwise}

dep.traj.all$phq_latentGrowthCurve_quadratic_withPairwiseCorrelations.out$output[283:337]

```

###### 3. intercept 0 for all  
***YES***

```{r check intercepts are zero quad pairwise}

dep.traj.all$phq_latentGrowthCurve_quadratic_withPairwiseCorrelations.out$output[545:556]
```

###### 4. correlations look sensible  
***YES***
```{r check correlations quad pairwise}

dep.traj.all$phq_latentGrowthCurve_quadratic_withPairwiseCorrelations.out$output[736:779]
```
##### Piecewise (4 pieces)

###### 1. loadings of indicators and intercepts are 1  
***YES***

###### 2. Estimates relate to specified timepoints  
**YES**
```{r check full output negative 4piece}

dep.traj.all$phq_latentGrowthCurve_piecewise_version1_4pieces.out$output[322:409]

```

###### 3. intercept 0 for all  
***YES***

```{r check intercepts are zero 4piece}

dep.traj.all$phq_latentGrowthCurve_piecewise_version1_4pieces.out$output[435:451]
```

###### 4. correlations look sensible  
***yes***
```{r check correlations 4piece}

dep.traj.all$phq_latentGrowthCurve_piecewise_version1_4pieces.out$output[788:830]
```

##### Piecewise (4 pieces) with correlations

###### 1. loadings of indicators and intercepts are 1  
***YES***

###### 2. Estimates relate to specified timepoints  
**YES**
```{r check full output negative 4piece cor}

dep.traj.all$phq_latentGrowthCurve_piecewise_version1_4pieces_wPairwise_correlations.out$output[328:414]

```

###### 3. intercept 0 for all  
***YES***

```{r check intercepts are zero 4piece cor}

dep.traj.all$phq_latentGrowthCurve_piecewise_version1_4pieces_wPairwise_correlations.out$output[684:700]
```

###### 4. correlations look sensible  
***yes***
```{r check correlations 4piece cor}

dep.traj.all$phq_latentGrowthCurve_piecewise_version1_4pieces_wPairwise_correlations.out$output[877:920]
```

##### Piecewise (3 pieces)

###### 1. loadings of indicators and intercepts are 1  
***YES***

###### 2. Estimates relate to specified timepoints  
**YES**
```{r check full output negative 3piece}

dep.traj.all$phq_latentGrowthCurve_piecewise_version2_3pieces.out$output[308:377]

```

###### 3. intercept 0 for all  
***YES***

```{r check intercepts are zero 3piece}

dep.traj.all$phq_latentGrowthCurve_piecewise_version2_3pieces.out$output[532:552]
```

###### 4. correlations look sensible  
***yes***
```{r check correlations 3piece}

dep.traj.all$phq_latentGrowthCurve_piecewise_version2_3pieces.out$output[726:769]
```



##### Piecewise (3 pieces) with pairwise correlations

###### 1. loadings of indicators and intercepts are 1  
***YES***

###### 2. Estimates relate to specified timepoints  
***YES***
```{r check full output negative 3piece pairwise}

dep.traj.all$phq_latentGrowthCurve_piecewise_version2_3pieces_wPairwiseCorrelations.out$output[312:380]

```

###### 3. intercept 0 for all  
***YES***

```{r check intercepts are zero 3piece pairwise}

dep.traj.all$phq_latentGrowthCurve_piecewise_version2_3pieces_wPairwiseCorrelations.out$output[446:464]
```
###### 4. correlations look sensible     

***yes***   

```{r check correlations 3piece pairwise}

dep.traj.all$phq_latentGrowthCurve_piecewise_version2_3pieces_wPairwiseCorrelations.out$output[816:860]
```



### Summary table of all fit indices

Sorted by BIC, as this is the most informative criteria (as per Muthens)

```{r create summary table}


justSummaries <- do.call("rbind.fill",
  sapply(dep.traj.all ,"[", "summaries")) %>%
  select(c("Title", "Observations", "Parameters", "AIC", "BIC", "CFI", "TLI", "SRMR", "RMSEA_Estimate")) %>%
  arrange(BIC)

justSummaries %>%
  kbl() %>%
  kable_styling()
```
### Plots {.tabset}

I show the plots for all runs that worked. Output for all runs is available in the GMM folder on GitHub to review input and output data that generated these plots. The main analytic sections above will only refer to the final model run. 

#### Timepoints where both studies have data

##### Format Data for Plots 

Plotting the estimated means for the trajectories with adjacent residuals correlated as these all had better fit than uncorrelated models

```{r Format Depression Growth Curve Data run 2}

dat_dep_run_2<-data.frame(matrix(nrow=15, ncol=8))

colnames(dat_dep_run_2)<-c("Linear", "LinearWithCorrelations",  "Quadratic", "QuadraticWithCorrelations",  "Piecewise_3pieces", "Piecewise_3piecesWithCorrelations","Piecewise_4pieces", "Piecewise_4piecesWithCorrelations")


dat_dep_run_2$Linear <-dep.traj.all$phq_latentGrowthCurve_linear.out$gh5$means_and_variances_data$y_estimated_means$values
dat_dep_run_2$LinearWithCorrelations <- dep.traj.all$phq_latentGrowthCurve_linear_withpairwiseCorrelations.out$gh5$means_and_variances_data$y_estimated_means$values

dat_dep_run_2$Quadratic <-dep.traj.all$phq_latentGrowthCurve_quadratic.out$gh5$means_and_variances_data$y_estimated_means$values
dat_dep_run_2$QuadraticWithCorrelations <- dep.traj.all$phq_latentGrowthCurve_quadratic_withPairwiseCorrelations.out$gh5$means_and_variances_data$y_estimated_means$values


dat_dep_run_2$Piecewise_3pieces <- dep.traj.all$phq_latentGrowthCurve_piecewise_version2_3pieces.out$gh5$means_and_variances_data$y_estimated_means$values
dat_dep_run_2$Piecewise_3piecesWithCorrelations <- dep.traj.all$phq_latentGrowthCurve_piecewise_version2_3pieces_wPairwiseCorrelations.out$gh5$means_and_variances_data$y_estimated_means$values

dat_dep_run_2$Piecewise_4pieces <- dep.traj.all$phq_latentGrowthCurve_piecewise_version1_4pieces.out$gh5$means_and_variances_data$y_estimated_means$values
dat_dep_run_2$Piecewise_4piecesWithCorrelations <- dep.traj.all$phq_latentGrowthCurve_piecewise_version1_4pieces_wPairwise_correlations.out$gh5$means_and_variances_data$y_estimated_means$values


dat_dep_run_2$timepoint<-c(0:14) 

dat_dep_run_2<-dat_dep_run_2%>%pivot_longer(-timepoint, names_to = "Model", values_to = "score")%>%mutate(Model = factor(Model, levels = c("Linear", "LinearWithCorrelations", "Quadratic", "QuadraticWithCorrelations", "Piecewise_3pieces", "Piecewise_3piecesWithCorrelations", "Piecewise_4pieces", "Piecewise_4piecesWithCorrelations")))

```

##### Growth Curve Plot 

```{r Depression Growth Curve Forms run 2}

growth_curves_run2 <- ggplot() +
  geom_line(data = dat_dep_run_2,
        aes(x = timepoint, y = score, colour = Model), size = 1) +
  geom_point(data = dat_dep_run_2,
        aes(x = timepoint, y = score, colour = Model, shape=Model), show.legend = F) +
  scale_color_manual(values = pres.palette) +
  labs(x = "Follow up time point", y ="PHQ9 Score") +
  scale_y_continuous(expand = c(0,0), limits = c(6,10), breaks=seq(6, 10, 3)) + 
  scale_x_continuous(expand = c(0,0), limits = c(-0.5,14.5), breaks=seq(0, 14, by = 1)) +
  theme(panel.grid.major.y = element_line(size = 0.5,
                                        linetype = 'dashed',
                                        colour = "gray"),
        axis.text = element_text(colour="black", size = 14),
        axis.title = element_text(colour="black", size = 16),
        legend.key = element_blank(),
        legend.text = element_text(colour = "black", size = 11),
        panel.background = element_blank()) 

growth_curves_run2

```


#### Only pairwise correlations
As these make most theoretical sense and show better mode fit, show the trajectories onluy including residual correlations between adjacent time points to make it easier to compare the models


```{r Format Depression Growth Curve Data run 2b}

dat_dep_run_2b<-data.frame(matrix(nrow=15, ncol=4))

colnames(dat_dep_run_2b)<-c("Linear", "Quadratic",  "Piecewise_3Pieces", "Piecewise_4Pieces")


dat_dep_run_2b$Linear <- dep.traj.all$phq_latentGrowthCurve_linear_withpairwiseCorrelations.out$gh5$means_and_variances_data$y_estimated_means$values
dat_dep_run_2b$Piecewise_3Pieces <- dep.traj.all$phq_latentGrowthCurve_piecewise_version2_3pieces_wPairwiseCorrelations.out$gh5$means_and_variances_data$y_estimated_means$values
dat_dep_run_2b$Piecewise_4Pieces <- dep.traj.all$phq_latentGrowthCurve_piecewise_version1_4pieces_wPairwise_correlations.out$gh5$means_and_variances_data$y_estimated_means$values
dat_dep_run_2b$Quadratic <- dep.traj.all$phq_latentGrowthCurve_quadratic_withPairwiseCorrelations.out$gh5$means_and_variances_data$y_estimated_means$values

dat_dep_run_2b$timepoint<-c(0:14) 

dat_dep_run_2b<-dat_dep_run_2b%>%pivot_longer(-timepoint, names_to = "Model", values_to = "score")%>%mutate(Model = factor(Model, levels = c("Linear","Quadratic", "Piecewise_3Pieces","Piecewise_4Pieces")))
```



##### Growth Curve Plot 

```{r Depression Growth Curve Forms run 2b}
growth_curves_run2b <- ggplot() +
  geom_line(data = dat_dep_run_2b,
        aes(x = timepoint, y = score, colour = Model), size = 1) +
  geom_point(data = dat_dep_run_2b,
        aes(x = timepoint, y = score, colour = Model, shape=Model), show.legend = F) +
  scale_color_manual(values = pres.palette[c(4, 1:3)]) +
  labs(x = "Follow up time point", y ="PHQ9 Score") +
  scale_y_continuous(expand = c(0,0), limits = c(6,10), breaks=seq(6, 10, 3)) + 
  scale_x_continuous(expand = c(0,0), limits = c(-0.5,14.5), breaks=seq(0, 14, by = 1)) +
  theme(panel.grid.major.y = element_line(size = 0.5,
                                        linetype = 'dashed',
                                        colour = "gray"),
        axis.text = element_text(colour="black", size = 14),
        axis.title = element_text(colour="black", size = 16),
        legend.key = element_blank(),
        legend.text = element_text(colour = "black", size = 11),
        panel.background = element_blank()) 

growth_curves_run2b



```

#### Observed and estimated means
lot pairwise correlation versions only. Plot estimated means from model alongside the observed means from the data.

```{r Format Depression Growth Curve Data run 2 obs est}

dat_dep_run_2c<-data.frame(matrix(nrow=15, ncol=5))

colnames(dat_dep_run_2c)<-c("Linear","Quadratic", "Piecewise_3Pieces","Piecewise_4Pieces", "Observed")


dat_dep_run_2c$Linear <- dep.traj.all$phq_latentGrowthCurve_linear_withpairwiseCorrelations.out$gh5$means_and_variances_data$y_estimated_means$values
dat_dep_run_2c$Piecewise_3Pieces <- dep.traj.all$phq_latentGrowthCurve_piecewise_version2_3pieces_wPairwiseCorrelations.out$gh5$means_and_variances_data$y_estimated_means$values
dat_dep_run_2c$Piecewise_4Pieces <- dep.traj.all$phq_latentGrowthCurve_piecewise_version1_4pieces_wPairwise_correlations.out$gh5$means_and_variances_data$y_estimated_means$values
dat_dep_run_2c$Quadratic <- dep.traj.all$phq_latentGrowthCurve_quadratic_withPairwiseCorrelations.out$gh5$means_and_variances_data$y_estimated_means$values


dat_dep_run_2c$Observed <- dep.traj.all$phq_latentGrowthCurve_linear_withpairwiseCorrelations.out$gh5$means_and_variances_data$y_observed_means$values

dat_dep_run_2c$timepoint<-c(0:14) 

dat_dep_run_2c<-dat_dep_run_2c%>%pivot_longer(-timepoint, names_to = "Model", values_to = "score")%>%mutate(Model = factor(Model, levels = c("Linear","Quadratic","Piecewise_3Pieces","Piecewise_4Pieces", "Observed")))


dat_dep_run_2c <- dat_dep_run_2c %>%
  mutate(Type = case_when(Model == "Observed"~ "Observed",
                          TRUE ~ "Estimated"))
  
```






##### Growth Curve Plot 

```{r Depression Growth Curve Forms run 2 obs est}
growth_curves_run2c <- ggplot() +
  geom_line(data = dat_dep_run_2c,
        aes(x = timepoint, y = score, colour = Model,linetype=Type)) +
  geom_point(data = dat_dep_run_2c,
        aes(x = timepoint, y = score, colour = Model, shape=Model), show.legend = F) +
  scale_color_manual(values = pres.palette) +
  labs(x = "Follow up time point", y ="PHQ9 Score") +
  scale_y_continuous(expand = c(0,0), limits = c(6,10), breaks=seq(6, 10, 3)) + 
  scale_x_continuous(expand = c(0,0), limits = c(-0.5,14.5), breaks=seq(0, 14, by = 1)) +
  theme(panel.grid.major.y = element_line(size = 0.5,
                                        linetype = 'dashed',
                                        colour = "gray"),
        axis.text = element_text(colour="black", size = 14),
        axis.title = element_text(colour="black", size = 16),
        legend.key = element_blank(),
        legend.text = element_text(colour = "black", size = 11),
        panel.background = element_blank()) 

growth_curves_run2c



```

#### Run 1: all time points

##### Format Data for Plots 

Plotting the estimated means for the trajectories with adjacent residuals correlated as these all had better fit than uncorrelated models

```{r Format Depression Growth Curve Data}

dep.traj.run.1 <- readModels("./MPlus_input_lcga/PHQ/Output_Run1_alltimepoints", 
                           recursive=TRUE)


dat_dep_run_1<-data.frame(matrix(nrow=18, ncol=3))

colnames(dat_dep_run_1)<-c("Linear", "Quadratic",  "Piecewise3")

#  "LinearCor", "QuadraticCor","Piecewise4", "Piecewise4Cor",, "Piecewise3Cor"

dat_dep_run_1$Linear <-dep.traj.run.1$..MPlus_input_lcga.PHQ.Output_Run1_alltimepoints.phq_latentGrowthCurve_linear.out$gh5$means_and_variances_data$y_estimated_means$values

#dat_dep_run_1$LinearCor<-dep.traj.all$phq_latentGrowthCurve_linear_withpairwiseCorrelations.out$gh5$means_and_variances_data$y_estimated_means$values

dat_dep_run_1$Quadratic<-dep.traj.run.1$..MPlus_input_lcga.PHQ.Output_Run1_alltimepoints.phq_latentGrowthCurve_quadratic.out$gh5$means_and_variances_data$y_estimated_means$values

#dat_dep_run_1$QuadraticCor<-dep.traj.run.1$phq_latentGrowthCurve_quadratic_withPairwiseCorrelations.out$gh5$means_and_variances_data$y_estimated_means$values

#dat_dep_run_1$Piecewise4<-dep.traj.run.1$phq_latentGrowthCurve_piecewise_version1_4pieces.out$gh5$means_and_variances_data$y_estimated_means$values

#dat_dep_run_1$Piecewise4Cor<-dep.traj.run.1$phq_latentGrowthCurve_piecewise_version1_4pieces_wPairwise_correlations.out$gh5$means_and_variances_data$y_estimated_means$values


dat_dep_run_1$Piecewise3<-dep.traj.run.1$..MPlus_input_lcga.PHQ.Output_Run1_alltimepoints.phq_latentGrowthCurve_piecwewise_version2_3pieces.out$gh5$means_and_variances_data$y_estimated_means$values

#dat_dep_run_1$Piecewise3Cor<-dep.traj.run.1$phq_latentGrowthCurve_piecewise_version2_3pieces_wPairwiseCorrelations.out$gh5$means_and_variances_data$y_estimated_means$values


dat_dep_run_1$timepoint<-c(0:17) 

dat_dep_run_1<-dat_dep_run_1%>%pivot_longer(-timepoint, names_to = "Model", values_to = "score")%>%mutate(Model = factor(Model, levels = c("Linear","Quadratic","Piecewise3")))

```

##### Growth Curve Plot 

```{r Depression Growth Curve Forms}

growth_curves_run1 <- ggplot() +
  geom_line(data = dat_dep_run_1,
        aes(x = timepoint, y = score, colour = Model), size = 1) +
  geom_point(data = dat_dep_run_1,
        aes(x = timepoint, y = score, colour = Model, shape=Model), show.legend = F) +
  scale_color_manual(values = pres.palette[c(4, 1:3)]) +
  labs(x = "Follow up time point", y ="PHQ9 Score") +
  scale_y_continuous(expand = c(0,0), limits = c(6,10), breaks=seq(6, 10, 3)) + 
  scale_x_continuous(expand = c(0,0), limits = c(-0.5,18.5), breaks=seq(0, 18, by = 1)) +
  theme(panel.grid.major.y = element_line(size = 0.5,
                                        linetype = 'dashed',
                                        colour = "gray"),
        axis.text = element_text(colour="black", size = 14),
        axis.title = element_text(colour="black", size = 16),
        legend.key = element_blank(),
        legend.text = element_text(colour = "black", size = 11),
        panel.background = element_blank()) 

growth_curves_run1


```

# to do tomorrow on train
3. format outputs so they are less unreadable in markdown

